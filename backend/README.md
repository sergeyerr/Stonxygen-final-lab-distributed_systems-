# Бэкенд
Бэкенд представляет собой веб-сервер, написанный на Ruby с использованием
библиотеки Sinatra. Он предоставляет REST API, который используется фронтендом.
Сервер предполагается запускать в многопоточном режиме. В коде, обрабатывающем
запросы многопоточность не используется.

## Инструкция по запуску
Необходимо иметь Ruby установленным на системе.
Также необходимо установить Bundler командой `gem install bundler`
Затем в директории с проектом требуется выполнить следующие команды:

```bash
bundler install
ruby bin/serve.rb -e production -p <порт>
```

## Используемые переменные окружения
Для конфигурации адресов сервисов, к которым обращается бэкенд, используются
следующие переменные окружения:
* `MY_HOSTNAME`: адрес бэкенда в сети,
* `REDIS`: адрес экземпляра-мастера Redis,
* `REDIS_SENTINEL`: адрес для обнаружения экземлпяров Redis Sentinel,
* `RABBITMQ`: адрес системы очередей сообщений RabbitMQ,
* `AUTH_SERVICE`: адрес сервиса аутентификация,
* `USER_SERVICE`: адрес сервиса учёта пользователей.

## REST API
Бэкенд предоставляет RESTful API для клиентов.

Все запросы возвращают JSON объект с *как минимум* ключами
`success` и `reason`.

```jsonc
{
    "success": false,
    "reason": "something went wrong"
}
```

Поле `reason` как правило является пустой строкой, если значение
поля `success` имеет значение `true`.

Бэкенд поддерживает следующие запросы:

### `GET /api/ping`
Отправить запрос на сервер с целью получения минимального ответа.
Может быть использован, чтобы проверить, активен ли сервер.

### `GET /api/stock/list`
Получить список акций.
В случае успеха в возвращаемом JSON-объекта будет поле
`stocks`, являющееся списком JSON-объектов вида:

```jsonc
{
    "code": "AAPL",
    "organization": "Apple Inc.",
    "price": 17.0
}
```

### `POST /api/user/login`
Получить токен существующего пользователя по его имени и паролю.
Принимает JSON-объект следующего вида в теле запроса:

```jsonc
{
    "name": "username",
    "password": "password"
}
```

В случае успеха возвращает JSON-объект следующего вида:
```json
{
    "success": true,
    "reason": "",
    "user": {
        "name": "username",
        "stocks": [
            {
                "code": "AAPL",
                "organization": "Apple Inc.",
                "price": 17.0
            }
        ] 
    },
    "token":"b323b81f186ff23ahfe52..."
}
```

### `POST /api/user/signup`
Зарегистрировать пользователя в системе.

Принимаемые и возвращаемые объекты аналогичны `POST /api/user/login`.

### `POST /api/user/info`
Получить информацию о пользователе по токену.

Возвращает объект, аналогичный указанному в ### `POST /api/user/login`,
но без поля `token`.

### `POST /api/stock/buy`
Присвоить пользователю акцию.

В URL запроса должен быть параметр `code` с кодом акции.

Ожидается, что в cookies запроса передаётся токен для аутентификации.

Возвращает JSON-объект с минимальным набором ключей.

### `POST /api/stock/sell`
Отобрать у пользователя акцию.

Описание совпадает с `POST /api/stock/buy`.

### `GET /api/stock/statistic`
Получить *статистику* об акции относительно пользователя.

Входные данные совпадают с `POST /api/stock/buy`.

В случае успеха возвращает JSON-объект вида:

```json
{
    "success": true,
    "reason": "",
    "statistic": 30.0}
```

## Взаимодействие со Stats_Calculator
При поступлении запроса на получение статистики, сервер обращается в
хранилище Redis. В случае если статистика там не обнаруживается, в
очередь `statistic-queue` бэкенд отправляет сериализованное в JSON сообщение
в следующем формате:

```jsonc
{
    "user": "usr" // Имя пользователя, для которого требуется вычислить статистику
    "code": "APPL",
    "host": "me", // Адрес бэкенда в сети
    "port": 6666 // Порт, на котором бэкенд ожидает ответ
}
```

После отправки сообщений бэкенд в рамках обработки одного запроса
создает сокет-сервер на указанном в отправленном сообщении порту
и ждёт некоторое количество времени ответ. В случае поступления ненулевого
ответа бэкенд вновь обращается в Redis для получения статистики.
Если ответ не поступил вовремя или в Redis снова не оказалось нужной
статистики, в ответ на запрос отправляется ошибка.

## Взаимодействие с Auth
При поступлении запроса на регистрацию или аутентификацию бэкенд использует
gRPC-процедуры, предоставляемые сервисом Auth для обработки поступившего
запроса. В случае возникновения ошибки, она ретранслируется клиенту.

## Взаимодействие с UserService
При поступлении запроса на добавление или удаление акции, а
также запроса на получение всех акций пользователя бэкенд использует
gRPC-процедуры, предоставляемые сервисом UserService, для обработки
поступившего запроса.
Для получения списка всех акций пользователя, бэкенд также обращается
в хранилище Redis, чтобы по кодам, возвращаемым процедурой GetStocks,
найти полную информацию об акциях, приобретённых пользователем.
